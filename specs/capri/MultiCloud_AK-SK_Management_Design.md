# Multi-Cloud AK/SK Management Design

This document serves as the design specification for the Multi-Cloud AK/SK Management in OpenSDS. This proposal was drafted [here](https://docs.google.com/document/d/1P9GEFHIjFyqTn8ZPoBN2bLdeCY98iUOqDGu4kTSWZ9o/edit?usp=sharing).

## Background

Multi-Cloud AK/SK Management supports authenticating requests. When you send requests to Multi-Cloud, you sign the requests so that multi-cloud can identify who sent them. For providing complete control over how a request is sent to the multi-cloud, you sign requests with your access key, which consists of an access key ID and signing key. Requests are then allowed or denied in part based on the identity of the requester.

AK/SK Management helps secure requests in the following ways:

* **Identity Verification of the requester:**
Signing makes sure that the request has been sent via a valid access key requester.

* **In-transit data protection:**
In-transit request is prevented from tempering, some of the request elements are used to calculate a digest i.e. hash  of the request, and the resulting hash value is included as signature within the request. When multi-cloud receives the request, it uses the same information to calculate a hash and matches it against the hash value in your request. If the values don't match, multi-cloud denies the request.


## Objectives

### Goals

* Goal 1: Support keystone application credential management mechanism, provides improved security by limiting access and not exposing the user credentials.

    * Goal 1 - sub goal 1: Support keystone application credential management for the set of authentication credentials i.e. AK/SK.

    * Goal 1 - sub goal 2: Support keystone APIs such as PUT/POST/GET/DELETE for AK/SK.

* Goal 2: Develop multi-cloud AK/SK management mechanism, provides signing and authenticating requests to manage multi-cloud APIs.

    * Goal 2 - sub goal 1: Support a protocol for authenticating inbound API request to multi-cloud. Implement a custom HTTP scheme based on a keyed-HMAC authentication scheme.

    * Goal 2 - sub goal 2: Support signature validations for the inbound API request to multi-cloud.

### Non Goals

* Goal 1: Support role-based authorization for the multi-cloud users for API requests to PUT/POST/GET/DELETE a backend. Assign the set of roles the User has on multi-cloud.


## Design Details

The Multi-Cloud AK/SK Management design is shown in the following diagram:

![Multi-Cloud AK-SK Management Diagram](multicloud_ak-sk_management.PNG?raw=true "Multi-Cloud AK-SK Management Diagram")

Following are the steps for authenticating requests to Multi-Cloud API:

1. Construct a request to API handler.

2. Calculate the signature using signing key.

3. Send the request (include access key ID and signature) to API handler.

4. API Handler uses the access key ID to look up your secret access key from keystone.

5. API Handler calculates a signature from the request data and the signing key using the same algorithm that user used to calculate the signature sent in the request.

6. If the signature generated by API Handler matches with the user requested signature, the request is authentic. Else, the request is discarded and returns an error response.

### AK/SK Credential Management

User sends authentication credentials to keystone, the Identity service from keystone generates and returns a token. A token represents the authenticated identity of a user and, grants authorization. User can PUT/POST/GET/DELETE a credential as [here](https://developer.openstack.org/api-ref/identity/v3/index.html?expanded=list-credentials-detail,show-credential-details-detail,create-credential-detail#application-credentials).

### Signature Calculation and Validation

API requests to multi-cloud containing the authentication information must include a signature which is computed based on the request elements. To calculate a signature, concatenate request elements to form a string (string to sign) and then create a signing key using secret access key. Signing key is derived from the credential scope, which means that there is no need to include the key in the request. Then signing key is used to calculate the hash-based message authentication code (HMAC) of the string to sign.
When API handler receives the request, it performs the same steps to calculate the signature included in the request. API handler then compares its calculated signature to the one sent with the request. If the signatures match, the request is processed. If the signatures don't match, the request is denied.

AWS Signature Version 4 signing library i.e. aws-sigv4 can be used to generate the signature.

Following is the illustration for the signature calculation and validation process.

![Multi-Cloud Signature Calculation Diagram](multicloud_signature_calculation.PNG?raw=true "Multi-Cloud Signature Calculation Diagram")

![Multi-Cloud Signature Validation Diagram](multicloud_signature_validation.PNG?raw=true "Multi-Cloud Signature Validation Diagram")
